<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D Python-like Wrapper Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        .demo-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="range"] {
            width: 100%;
        }
        
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .expression-btn {
            background-color: #2196F3;
        }
        
        .expression-btn:hover {
            background-color: #1976D2;
        }
        
        .expression-btn.active {
            background-color: #FF9800;
        }
        
        .model-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .info-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        
        .info-card h3 {
            margin-top: 0;
            color: #333;
        }
        
        .info-item {
            margin: 5px 0;
        }
        
        .info-label {
            font-weight: bold;
            display: inline-block;
            width: 120px;
        }
        
        canvas {
            display: block;
            margin: 20px auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Live2D Python-like Wrapper Demo</h1>
        
        <div class="demo-section">
            <h2>Model Information</h2>
            <div id="modelInfo" class="model-info">
                <div class="info-card">
                    <h3>Canvas Info</h3>
                    <div class="info-item"><span class="info-label">Width:</span> <span id="canvasWidth">-</span></div>
                    <div class="info-item"><span class="info-label">Height:</span> <span id="canvasHeight">-</span></div>
                    <div class="info-item"><span class="info-label">Pixels/Unit:</span> <span id="pixelsPerUnit">-</span></div>
                </div>
                <div class="info-card">
                    <h3>Drawables</h3>
                    <div class="info-item"><span class="info-label">Count:</span> <span id="drawableCount">-</span></div>
                    <div class="info-item"><span class="info-label">Visible:</span> <span id="visibleCount">-</span></div>
                </div>
                <div class="info-card">
                    <h3>Parameters</h3>
                    <div class="info-item"><span class="info-label">Count:</span> <span id="paramCount">-</span></div>
                </div>
                <div class="info-card">
                    <h3>Parts</h3>
                    <div class="info-item"><span class="info-label">Count:</span> <span id="partCount">-</span></div>
                </div>
            </div>
        </div>
        
        <div class="demo-section">
            <h2>Live2D Model</h2>
            <div id="status" class="status loading">Loading model...</div>
            <canvas id="live2dCanvas" width="400" height="600"></canvas>
        </div>
        
        <div class="demo-section">
            <h2>Parameter Controls</h2>
            <div class="controls" id="parameterControls">
                <!-- Parameter controls will be dynamically added here -->
            </div>
        </div>
        
        <div class="demo-section">
            <h2>Expressions</h2>
            <div class="controls">
                <button class="expression-btn" data-expr="smile">Smile</button>
                <button class="expression-btn" data-expr="wink">Wink</button>
                <button class="expression-btn" data-expr="surprise">Surprise</button>
                <button class="expression-btn" data-expr="angry">Angry</button>
            </div>
        </div>
        
        <div class="demo-section">
            <h2>Model Operations</h2>
            <div class="controls">
                <button id="resetBtn">Reset to Default</button>
                <button id="autoAnimBtn">Toggle Auto Animation</button>
                <button id="logParamsBtn">Log Parameters</button>
                <button id="logDrawablesBtn">Log Drawables</button>
            </div>
        </div>
    </div>

    <!-- Load Live2D Core -->
    <script src="live2dcubismcore.min.js"></script>
    
    <!-- Load our wrapper classes -->
    <script src="Live2DWrapper.js"></script>
    
    <script>
        // Main application
        class Live2DWrapperDemo {
            constructor() {
                this.model = null;
                this.renderer = null;
                this.canvas = null;
                this.gl = null;
                this.animationId = null;
                this.isAutoAnimating = true;
                
                this.init();
            }
            
            async init() {
                this.canvas = document.getElementById('live2dCanvas');
                this.gl = this.canvas.getContext('webgl', {
                    alpha: true,
                    premultipliedAlpha: true,
                    antialias: true,
                    stencil: true
                });
                
                if (!this.gl) {
                    this.showError('WebGL not supported');
                    return;
                }
                
                try {
                    // Load the model using our wrapper
                    this.model = await Live2DModel.fromURL('models/Hiyori/Hiyori.model3.json');
                    
                    // Create renderer
                    this.renderer = new Live2DRenderer(this.gl, this.model);
                    
                    // Load textures
                    const modelDir = 'models/Hiyori';
                    const texturePaths = [
                        `${modelDir}/textures/texture_00.png`
                    ];
                    await this.renderer.loadTextures(texturePaths);
                    
                    this.showSuccess('Model loaded successfully!');
                    this.updateModelInfo();
                    this.createParameterControls();
                    this.setupEventHandlers();
                    this.startAnimation();
                } catch (error) {
                    this.showError(`Failed to load model: ${error.message}`);
                    console.error('Model loading error:', error);
                }
            }
            
            updateModelInfo() {
                if (!this.model) return;
                
                document.getElementById('canvasWidth').textContent = this.model.canvasInfo.width;
                document.getElementById('canvasHeight').textContent = this.model.canvasInfo.height;
                document.getElementById('pixelsPerUnit').textContent = this.model.canvasInfo.pixelsPerUnit;
                document.getElementById('drawableCount').textContent = this.model.drawables.count;
                document.getElementById('paramCount').textContent = this.model.parameters.count;
                document.getElementById('partCount').textContent = this.model.parts.count;
                
                // Count visible drawables
                let visibleCount = 0;
                for (let i = 0; i < this.model.drawables.count; i++) {
                    if (this.model.drawables.isVisible(i)) visibleCount++;
                }
                document.getElementById('visibleCount').textContent = visibleCount;
            }
            
            createParameterControls() {
                const container = document.getElementById('parameterControls');
                container.innerHTML = '';
                
                // Only show a few key parameters to avoid clutter
                const keyParams = [
                    'ParamAngleX', 'ParamAngleY', 'ParamAngleZ',
                    'ParamEyeLOpen', 'ParamEyeROpen',
                    'ParamEyeBallX', 'ParamEyeBallY',
                    'ParamMouthOpenY', 'ParamMouthForm'
                ];
                
                for (const paramName of keyParams) {
                    const index = this.model.parameters.getIndexById(paramName);
                    if (index !== undefined) {
                        const param = {
                            name: paramName,
                            index: index,
                            value: this.model.parameters.get(paramName),
                            min: this.model.parameters.getMinimum(index),
                            max: this.model.parameters.getMaximum(index)
                        };
                        
                        const controlGroup = document.createElement('div');
                        controlGroup.className = 'control-group';
                        
                        const label = document.createElement('label');
                        label.textContent = param.name;
                        
                        const valueSpan = document.createElement('span');
                        valueSpan.textContent = param.value.toFixed(3);
                        valueSpan.style.display = 'inline-block';
                        valueSpan.style.width = '50px';
                        valueSpan.style.textAlign = 'right';
                        
                        const slider = document.createElement('input');
                        slider.type = 'range';
                        slider.min = param.min;
                        slider.max = param.max;
                        slider.step = 0.01;
                        slider.value = param.value;
                        slider.addEventListener('input', (e) => {
                            const value = parseFloat(e.target.value);
                            this.model.parameters.set(paramName, value);
                            valueSpan.textContent = value.toFixed(3);
                        });
                        
                        controlGroup.appendChild(label);
                        controlGroup.appendChild(valueSpan);
                        controlGroup.appendChild(slider);
                        
                        container.appendChild(controlGroup);
                    }
                }
            }
            
            setupEventHandlers() {
                // Expression buttons
                document.querySelectorAll('.expression-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const expr = e.target.dataset.expr;
                        this.model.setExpression(expr);
                        
                        // Toggle active state
                        btn.classList.toggle('active');
                        
                        // Auto remove active after 2 seconds
                        setTimeout(() => {
                            btn.classList.remove('active');
                        }, 2000);
                    });
                });
                
                // Reset button
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.model.reset();
                    this.createParameterControls(); // Update controls to reflect reset values
                });
                
                // Auto animation toggle
                document.getElementById('autoAnimBtn').addEventListener('click', () => {
                    this.isAutoAnimating = !this.isAutoAnimating;
                    if (this.isAutoAnimating) {
                        this.startAnimation();
                    } else {
                        this.stopAnimation();
                    }
                });
                
                // Log parameters button
                document.getElementById('logParamsBtn').addEventListener('click', () => {
                    console.log('Parameters:');
                    for (const param of this.model.parameters) {
                        console.log(`${param.name}: ${param.value} (min: ${param.minimum}, max: ${param.maximum})`);
                    }
                });
                
                // Log drawables button
                document.getElementById('logDrawablesBtn').addEventListener('click', () => {
                    console.log('Drawables:');
                    for (let i = 0; i < this.model.drawables.count; i++) {
                        console.log(`Drawable ${i} (${this.model.drawables.getId(i)}): opacity=${this.model.drawables.getOpacity(i)}, visible=${this.model.drawables.isVisible(i)}`);
                    }
                });
                
                // Click on canvas for interaction
                this.canvas.addEventListener('click', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Calculate relative position to center
                    const centerX = this.canvas.width / 2;
                    const centerY = this.canvas.height / 2;
                    const relX = (x - centerX) / centerX;
                    const relY = (y - centerY) / centerY;
                    
                    // Update eye tracking parameters based on click position
                    this.model.parameters.set('ParamEyeBallX', relX * 0.5);
                    this.model.parameters.set('ParamEyeBallY', relY * 0.5);
                    this.model.parameters.set('ParamAngleX', relX * 30);
                    this.model.parameters.set('ParamAngleY', relY * 30);
                });
            }
            
            startAnimation() {
                if (this.animationId) return;
                
                const animate = () => {
                    if (!this.isAutoAnimating) return;
                    
                    // Auto animation - simple breathing and eye blinking
                    const time = this.model.time;
                    const breathValue = 0.5 + 0.1 * Math.sin(time * 2); // Breathing
                    this.model.parameters.set('ParamBreath', breathValue);
                    
                    // Eye blinking (every 3-5 seconds)
                    if (Math.sin(time * 0.3) > 0.9) {
                        this.model.parameters.set('ParamEyeLOpen', 0.2);
                        this.model.parameters.set('ParamEyeROpen', 0.2);
                    } else {
                        this.model.parameters.set('ParamEyeLOpen', 1.0);
                        this.model.parameters.set('ParamEyeROpen', 1.0);
                    }
                    
                    // Update model
                    this.model.update(16.67);
                    
                    // Update renderer buffers
                    this.renderer.updateBuffers();
                    
                    // Render
                    const gl = this.gl;
                    gl.viewport(0, 0, this.canvas.width, this.canvas.height);
                    gl.clearColor(0.0, 0.0, 0.0, 0.0);
                    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                    
                    // Create orthographic projection matrix
                    const projectionMatrix = this.createOrthographicMatrix(
                        0, this.canvas.width, this.canvas.height, 0, -1, 1
                    );
                    
                    this.renderer.render(projectionMatrix);
                    
                    this.animationId = requestAnimationFrame(animate);
                };
                
                animate();
            }
            
            stopAnimation() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            }
            
            createOrthographicMatrix(left, right, bottom, top, near, far) {
                const matrix = new Float32Array(16);
                
                matrix[0] = 2 / (right - left);
                matrix[5] = 2 / (top - bottom);
                matrix[10] = -2 / (far - near);
                matrix[12] = -(right + left) / (right - left);
                matrix[13] = -(top + bottom) / (top - bottom);
                matrix[14] = -(far + near) / (far - near);
                matrix[15] = 1;
                
                return matrix;
            }
            
            showSuccess(message) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = 'status success';
            }
            
            showError(message) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = 'status error';
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', () => {
            new Live2DWrapperDemo();
        });
    </script>
</body>
</html>